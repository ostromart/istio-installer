syntax = "proto2";

package v1alpha1;

import "k8s.io/api/core/v1/generated.proto";
import "k8s.io/api/autoscaling/v1/generated.proto";
import "k8s.io/apimachinery/pkg/apis/meta/v1/generated.proto";

// InstallerSpec defines the desired state of IstioInstaller.
message InstallerSpec {
    // Tracer config options.
    message LightstepConfig {
        optional bool enabled = 1;
        optional string address = 2;
        optional string access_token = 3;
        optional string ca_cert_path = 4;
        optional bool secure = 5;
    }
    message ZipkinConfig {
        optional bool enabled = 1;
        optional string address = 2;
    }
    message NodeAffinity {
        optional uint32 arch_amd64 = 1;
        optional uint32 arch_s390x = 2;
        optional uint32 arch_ppc64le = 3;
    }

    // install_package_path is the URL for the install package to install e.g.
    //   http://github.com/istio/istio/releases/install/1.1.2
    //   http://github.com/istio/istio/releases/install/lts
    //   file://tmp/istio-installer/nightly
    // Optional. Uses compiled in install package by default.
    optional string install_package_path = 1;

    // hub is the root for docker images e.g. docker.io/istio-release.
    optional string hub = 3;
    // tag is the version tag for docker images e.g. 1.0.6
    optional string tag = 4;

    // default_namespace_prefix is the prefix added to all namespaces for any installed component. Required.
    optional string default_namespace_prefix = 5;

    // remote_cluster configures the cluster as a remote cluster.
    optional RemoteClusterConfig remote_cluster = 10;

    optional uint32 monitoring_port = 11;

    optional string image_pull_policy = 12;

    repeated string mesh_networks = 13;

    optional MeshExpansionConfig mesh_expansion = 14;

    optional string trust_domain = 15;

    optional bool use_MCP = 16;

    // Tracer options. At most one can be enabled.
    optional LightstepConfig lightstep = 17;
    optional ZipkinConfig zipkin = 18;

    optional NodeAffinity node_affinity = 19;

    optional string priorityClassName = 20;

    // Selection and configuration of core Istio features.
    optional TrafficManagementConfig traffic_management = 25;
    optional PolicyConfig policy = 26;
    optional TelemetryConfig telemetry = 27;
    optional SecurityConfig security = 28;
    optional ConfigManagementConfig config_management = 29;

    // Ingress/egress gateway installation and configuration.
    repeated IngressGatewayConfig ingress_gateway = 30;
    repeated EgressGatewayConfig egress_gateway = 31;

    // List of external operators that will be installed (but not managed by)
    // IstioInstaller e.g. prometheus, grafana, kiali.
    repeated OperatorConfig external_operators = 50;

    optional ResourceRequirements default_resources = 80;
    optional PodDisruptionBudgetSpec default_pod_disruption_budget = 87;

    // Default node selectors, can be overridden per feature.
    map<string, string> default_node_selector = 92;
}

// InstallerStatus defines the observed state of IstioInstaller.
// TODO: this needs more work. What do we want to observe?
message InstallerStatus {
    optional string proxy_control = 1;
    optional string sidecar_injector = 2;
    // etc.
}

// RemoteClusterConfig defines configuration options for remote clusters.
message RemoteClusterConfig {
    // Enabled selects whether the cluster is configured as remote.
    optional bool enabled = 1;

    optional string remote_pilot_address = 10;
    optional string remote_telemetry_address = 11;
    optional string remote_policy_address = 12;

    // Note: this is a placeholder. Manual steps will still be initially required for this to work.
}

message MeshExpansionConfig {
    optional bool enabled = 1;
    optional bool use_ILB = 2;
}

// TrafficManagementConfig defines configuration options for proxy control and injection.
message TrafficManagementConfig {
    // Selects whether traffic management is installed.
    optional bool enabled = 1;

    // Namespace that all components for this feature are installed into.
    optional string namespace = 2;

    // When set to true, auto injection is controlled by namespace label and pod annotation.
    // When set to false, auto injection is completely disabled.
    optional bool auto_injection = 10;

    // Component specific config.
    optional PilotConfig pilot = 11;
    optional ProxyConfig proxy = 12;
    optional SidecarInjectorConfig sidecar_injector = 13;
}

// PilotConfig defines the configuration options for pilot.
message PilotConfig {
    // Enables debug in pilot.
    optional bool debug = 1;
    optional string namespace = 2;

    // Enables sidecar in the pilot pod.
    optional bool sidecar = 10;
    // Trace sampling percentage.
    optional float trace_sampling = 11;

    optional string keepaliveMaxServerConnectionAge = 12;

    // Additional arguments passed to pilot discovery.
    map<string, string> additional_args = 50;
    // Additional environment variables for the discovery container.
    map<string, string> env = 60;

    // Passthrough to corresponding k8s settings.
    optional ResourceRequirements resources = 80;

    // k8s scaling settings.
    optional uint32 replica_count = 85;
    optional k8s.io.api.autoscaling.v1.HorizontalPodAutoscalerSpec hpa_spec = 86;
    optional PodDisruptionBudgetSpec pod_disruption_budget = 87;

    // Annotations and selectors.
    map<string, string> node_selector = 92;

    // Kustomize style overrides for k8s resources in rendered manifests.
    repeated ResourceOverride resource_override = 100;
}

// ProxyConfig defines the configuration options for the injected Envoy proxy.
message ProxyConfig {
    enum InterceptionMode {
        REDIRECT = 0;
        TPROXY = 1;
    }

    // Enables debug in the proxy.
    optional bool debug = 1;

    // TBD: is privileged ever set in isolation?
    optional bool privileged = 10;
    // Enables coredump in proxy container.
    optional bool enable_coredump = 11;
    optional InterceptionMode interception_mode = 12;
    // Below settings would otherwise be implemented as a k8s overlay but because the proxy resources are defined
    // as a ConfigMap containing a second template, it's probably too difficult to override fields in the k8s
    // ConfigMap.
    optional uint32 status_port = 13;
    optional string image_pull_policy = 14;
    optional string proxy_init_image = 15;

    // Address and port filtering.
    optional string include_ip_ranges = 16;
    optional string exclude_ip_ranges = 17;
    optional string include_inbound_ports = 18;
    optional string exclude_inbound_ports = 19;

    // Envoy specific timer settings.
    optional string connect_timeout = 20;
    optional string drain_duration = 21;
    optional string parent_shutdown_duration = 22;

    optional uint32 concurrency = 23;

    optional string cluster_domain = 24;
    optional string pod_dns_search_namespaces = 25;

    // SDS settings
    optional SdsConfig sds = 40;

    // Additional arguments passed to Envoy.
    map<string, string> additional_args = 50;
    // Additional environment variables for the container.
    map<string, string> env = 60;

    // Passthrough to k8s resources.
    optional ResourceRequirements resources = 80;
    optional k8s.io.api.core.v1.Probe readiness_probe = 81;

    // Kustomize style overrides for k8s resources in rendered manifests.
    repeated ResourceOverride resource_override = 100;
}

message SidecarInjectorConfig {
    // Enables debug in pilot.
    optional bool debug = 1;
    optional string namespace = 2;

    optional bool enable_namespaces_by_default = 10;

    // k8s scaling settings.
    optional uint32 replica_count = 85;

    // Annotations and selectors.
    map<string, string> node_selector = 92;
 }

message PolicyConfig {
    // Set the default behavior of the sidecar for handling outbound traffic from the application.
    enum OutboundPolicy {
        // Outbound traffic to unknown destinations will be allowed, in case there are no
        //   services or ServiceEntries for the destination port
        ALLOW_ANY = 0;
        // Restrict outbound traffic to services defined in the service registry as well
        // as those defined through ServiceEntries
        REGISTRY_ONLY = 1;
    }

    // Selects whether policy enforcement is installed.
    // Q. is this enough to cover both mixer.policy.enabled and disablePolicyChecks?
    optional bool enabled = 1;

    // Namespace that all components for this feature are installed into.
    optional string namespace = 2;

    // policyCheckFailOpen allows traffic in cases when the mixer policy service cannot be reached.
    optional bool policy_check_fail_open = 10;

    optional OutboundPolicy outbound_traffic_policy_mode = 11;

    // Additional environment variables for the container.
    map<string, string> env = 60;

    // Passthrough to k8s resources.
    optional ResourceRequirements resources = 80;

    // k8s scaling settings.
    optional uint32 replica_count = 85;
    optional k8s.io.api.autoscaling.v1.HorizontalPodAutoscalerSpec hpa_spec = 86;
    optional PodDisruptionBudgetSpec pod_disruption_budget = 87;

    // Kustomize style overrides for k8s resources in rendered manifests.
    repeated ResourceOverride resource_override = 100;
}

message TelemetryConfig {
    enum LoadSheddingMode {
        ENFORCE = 0;
        LOGONLY = 1;
        DISABLED = 2;
    }
    message Adapters {
        message KubernetesEnv {
            optional bool enabled = 1;
        }
        message Stdio {
            optional bool enabled = 1;
            optional bool output_as_json = 2;
        }
        message Prometheus {
            optional bool enabled = 1;
            optional string metrics_expiry_duration = 2;
        }

        optional bool use_adapter_CRDs = 1;

        optional KubernetesEnv kubernetes_env_config = 2;
        optional Stdio stdio = 3;
        optional Prometheus prometheus = 4;
    }
    // Selects whether policy enforcement is installed.
    optional bool enabled = 1;

    // Namespace that all components for this feature are installed into.
    optional string namespace = 2;

    optional bool session_affinity_enabled = 10;
    // Load shedding mode defines mixer behavior under load. If response time threshold is exceeded, the chosen
    // load shedding behavior will occur.
    optional LoadSheddingMode load_shedding_mode = 11;
    // If the response time exceeds the threshold, the chosen load shedding behavior will take effect.
    optional string load_shedding_latency_threshold = 12;

    // k8s scaling settings.
    optional uint32 replica_count = 80;

    // Annotations and selectors.
    map<string, string> pod_annotations = 90;
    map<string, string> node_selector = 92;

    // Kustomize style overrides for k8s resources in rendered manifests.
    repeated ResourceOverride resource_override = 100;
}

message SecurityConfig {
    message Citadel {
        // Selects whether citadel is installed.
        optional bool enabled = 1;

        optional bool self_signed = 11;

        optional bool create_mesh_policy = 12;

        // k8s scaling settings.
        optional uint32 replica_count = 80;

        // Annotations and selectors.
        map<string, string> node_selector = 92;

        // Kustomize style overrides for k8s resources in rendered manifests.
        repeated ResourceOverride resource_override = 100;

    }
    message CertManager {
        // Selects whether cert manager is installed.
        optional bool enabled = 1;
        // Namespace that all components for this feature are installed into.
        optional string namespace = 2;

        // hub is the path for docker images e.g. quay.io/jetstack
        // TODO: clarify if image name default exists.
        optional string hub = 3;
        // tag is the version tag for docker images e.g. 1.0.6
        optional string tag = 4;

        // Passthrough to k8s resources.
        optional ResourceRequirements resources = 82;

        // Kustomize style overrides for k8s resources in rendered manifests.
        repeated ResourceOverride resource_override = 100;

    }
    message NodeAgent {
        // Selects whether node agent is installed.
        optional bool enabled = 1;
        optional string image = 2;

        // Additional environment variables for the container.
        map<string, string> env = 60;

        // Kustomize style overrides for k8s resources in rendered manifests.
        repeated ResourceOverride resource_override = 100;
    }
    // Selects whether security feature is installed.
    optional bool enabled = 1;

    // Namespace that all components for this feature are installed into.
    optional string namespace = 2;

    // Enable MTLS for control plane. Will result in delays starting the pods while secrets arepropagated, not recommended for tests
    optional bool control_plane_mtls = 13;

    // Enable MTLS for service to service traffic.
    optional bool data_plane_mtls = 14;

    optional Citadel citadel = 20;
    optional CertManager cert_manager = 21;
    optional NodeAgent node_agent = 22;

}

message ConfigManagementConfig {
    // Selects whether config management is installed.
    optional bool enabled = 1;

    // Namespace that all components for this feature are installed into.
    optional string namespace = 2;

    optional string image = 10;

    // k8s scaling settings.
    optional uint32 replica_count = 80;

    // Kustomize style overrides for k8s resources in rendered manifests.
    repeated ResourceOverride resource_override = 100;
}

message IngressGatewayConfig {
    message Sds {
        // Selects whether config management is installed.
        optional bool enabled = 1;
        optional string image = 10;
    }

    optional string load_balancer_iP = 11;
    repeated string load_balancer_source_ranges = 12;
    repeated string external_iPs = 13;
}

message EgressGatewayConfig {
    optional GatewayConfig gateway = 10;
}

message IlbGatewayConfig {
    optional GatewayConfig gateway = 10;
    optional string load_balancer_iP = 11;
}

message GatewayConfig {
    message Labels {
        optional string app = 1;
        optional string istio = 2;
    }
    // NodePort, ClusterIP or LoadBalancer.
    optional string type = 10;

    // Additional environment variables for the container.
    map<string, string> env = 60;

    // k8s scaling settings.
    optional k8s.io.api.autoscaling.v1.HorizontalPodAutoscalerSpec hpa_spec = 86;

    // Annotations and selectors.
    map<string, string> pod_annotations = 90;
    map<string, string> service_annotations = 91;
    map<string, string> node_selector = 92;

    // Kustomize style overrides for k8s resources in rendered manifests.
    repeated ResourceOverride resource_override = 100;
}

// OperatorConfig defines a config used to install an external operator.
message OperatorConfig {
    // manifest_path is the URL for the operator install manifest.
    optional string manifest_path = 1;

    // namespace is the namespace the operator manifest and CR are installed into.
    optional string namespace = 2;

    // spec is the initial CR for the operator.
    optional ResourceOverride spec = 100;
}

message IstioInstaller {
    optional InstallerSpec spec = 3;
    optional InstallerStatus status = 4;
}

// ResourceRequirements describes the compute resource requirements.
// Mirrors k8s.io.api.core.v1.ResourceRequirements for Unmarshaling.
message ResourceRequirements {
    map<string, string> limits = 1;
    map<string, string> requests = 2;
}

// PodDisruptionBudgetSpec is a description of a PodDisruptionBudget.
// Mirrors k8s.io.api.policy.v1beta1.PodDisruptionBudget for Unmarshaling.
message PodDisruptionBudgetSpec {
    optional uint32 min_available = 1;
    optional k8s.io.apimachinery.pkg.apis.meta.v1.LabelSelector selector = 2;
    optional uint32 max_unavailable = 3;
}

// ResourceOverride specifies a patch for an existing k8s resource.
message ResourceOverride {
    enum PatchType {
        STRATEGIC = 0;
        JSON = 1;
    }
    enum Op {
        ADD = 0;
        DELETE = 1;
        PATCH = 2;
    }

    optional PatchType patch_type = 1;
    optional Op op = 2;

    // From k8s.io.apimachinery.pkg.apis.meta.v1.ObjectMeta.TypeMeta
    optional string kind = 3;
    optional string api_version = 4;

    optional ObjectMeta metadata = 5;

    // Data map[string]interface{} `protobuf:"bytes,6,opt,name=data" json:"data,omitempty"`
}

message ObjectMeta {
    // From k8s.io.apimachinery.pkg.apis.meta.v1.ObjectMeta
    optional string name = 5;
    optional string namespace = 6;
}

// FIXME: this should be moved out
message SdsConfig {
    optional bool enabled = 1;
    optional string uds_path = 2;
    optional bool use_trustworthy_jwt = 3;
    optional bool use_normal_jwt = 4;
}

// TestKube are for testing that k8s resources unmarshal correctly.
message TestKube {
    optional ResourceRequirements resources = 80;
    optional k8s.io.api.core.v1.Probe readiness_probe = 81;

    optional k8s.io.api.autoscaling.v1.HorizontalPodAutoscalerSpec hpa_spec = 51;
    optional PodDisruptionBudgetSpec pod_disruption_budget = 52;

    // Kustomize style overrides for k8s resources in rendered manifests.
    repeated ResourceOverride resource_override = 100;
}


