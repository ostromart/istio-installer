syntax = "proto2";

package v1alpha1;

import "k8s.io/api/core/v1/generated.proto";
import "k8s.io/api/policy/v1beta1/generated.proto";
import "k8s.io/api/autoscaling/v1/generated.proto";
import "k8s.io/apimachinery/pkg/apis/meta/v1/generated.proto";
import "k8s.io/apimachinery/pkg/runtime/generated.proto";

// InstallerSpec defines the desired state of IstioInstaller.
message InstallerSpec {
    // install_package_path is the URL for the install package to install e.g.
    //   http://github.com/istio/istio/releases/install/1.1.2
    //   http://github.com/istio/istio/releases/install/lts
    //   file://tmp/istio-installer/nightly
    // Optional. Uses compiled in install package by default.
    optional string install_package_path = 1;

    // controller_name binds the CR to the install controller
    // that should listen to it. Used when multiple versions of controllers
    // coexist in a cluster and to prevent old versions of controller from
    // consuming new version of config.
    optional string controller_name = 2;

    // hub is the root for docker images e.g. docker.io/istio-release.
    optional string hub = 3;
    // tag is the version tag for docker images e.g. 1.0.6
    optional string tag = 4;

    // default_namespace is the default namespace for components if their
    // namespace is not explicitly set. Required.
    optional string default_namespace = 5;

    // remote_cluster_config configures the cluster as a remote cluster.
    optional RemoteClusterConfig remote_cluster_config = 10;

    // Selection and configuration of core Istio features.
    optional TrafficManagementConfig traffic_management = 20;
    optional PolicyConfig policy = 21;
    optional TelemetryConfig telemetry = 22;
    optional SecurityConfig security = 23;
    optional ConfigManagementConfig config_management = 24;

    // Ingress/egress gateway installation and configuration.
    repeated IngressGatewayConfig ingress_gateway = 30;
    repeated EgressGatewayConfig egress_gateway = 31;

    // List of external operators that will be installed (but not managed by)
    // IstioInstaller e.g. prometheus, grafana, kiali.
    repeated OperatorConfig external_operators = 50;

    // TBD. any global settings?
    // e.g. ImagePullPolicy, DefaultResourcesâ€¦
    // See sheet for list.
}

// InstallerStatus defines the observed state of IstioInstaller.
// TODO: this needs more work. What do we want to observe?
message InstallerStatus {
    optional string proxy_control = 1;
    optional string sidecar_injector = 2;
    // etc.
}

// RemoteClusterConfig defines configuration options for remote clusters.
message RemoteClusterConfig {
    // Enabled selects whether the cluster is configured as remote.
    optional bool enabled = 1;

    // Namespace that all components for this feature are installed into.
    optional string namespace = 2;

    // resource_override is a kustomize style overlay to kubernetes resources
    // in the manifests rendered from the chart templates using included
    // values.yaml with ValuesOverride above.
    repeated Object resource_override = 3;

    // TBD, see sheet.
}

// TrafficManagementConfig defines configuration options for proxy control and injection.
message TrafficManagementConfig {
    // Selects whether traffic management is installed.
    optional bool enabled = 1;

    // Namespace that all components for this feature are installed into.
    optional string namespace = 2;

    // When set to true, auto injection is controlled by namespace label and pod annotation.
    // When set to false, auto injection is completely disabled.
    optional bool auto_injection = 3;

    // Component specific config.
    optional PilotConfig pilot_config = 4;
    optional ProxyConfig proxy_config = 5;
}

// PilotConfig defines the configuration options for pilot.
message PilotConfig {
    // Enables debug in pilot.
    optional bool debug = 1;

    // Enables sidecar in the pilot pod.
    optional bool sidecar = 2;

    // Trace sampling percentage.
    optional float trace_sampling = 3;

    // Passthrough to corresponding k8s settings.
    optional k8s.io.api.core.v1.ResourceRequirements resources = 50;
    optional k8s.io.api.autoscaling.v1.HorizontalPodAutoscalerSpec hpa_spec = 51;
    optional k8s.io.api.policy.v1beta1.PodDisruptionBudget pod_disruption_budget = 52;
    optional k8s.io.api.core.v1.NodeSelector nodeSelector = 53;

    // Additional arguments passed to pilot discovery.
    map<string, string> additional_args = 60;

    // Additional environment variables for the discovery container.
    map<string, string> env = 70;

    // Kustomize style overrides for k8s resources in rendered manifests.
    repeated Object resource_override = 100;
}

// ProxyConfig defines the configuration options for the injected Envoy proxy.
message ProxyConfig {
    enum InterceptionMode {
        REDIRECT = 0;
        TPROXY = 1;
    }

    // Tracer config options.
    message LightstepConfig {
        optional string address = 1;
        optional string access_token = 2;
        optional string ca_cert_path = 3;
        optional bool secure = 4;
    }
    message ZipkinConfig {
        optional string address = 1;
    }

    // Enables debug in the proxy.
    optional bool debug = 1;

    // TBD: is privileged ever set in isolation?
    optional bool privileged = 2;

    // Enables coredump in proxy container.
    optional bool enable_coredump = 3;

    optional InterceptionMode interception_mode = 4;

    // Below settings would otherwise be implemented as a k8s overlay but because the proxy resources are defined
    // as a ConfigMap containing a second template, it's probably too difficult to override fields in the k8s
    // ConfigMap.
    optional uint32 status_port = 5;
    optional string image_pull_policy = 6;
    optional string proxy_init_image = 7;

    // Address and port filtering.
    optional string include_ip_ranges = 8;
    optional string exclude_ip_ranges = 9;
    optional string include_inbound_ports = 10;
    optional string exclude_inbound_ports = 11;

    // Envoy specific timer settings.
    optional string connect_timeout = 12;
    optional string drain_duration = 13;
    optional string parent_shutdown_duration = 14;

    optional uint32 concurrency = 15;

    optional string cluster_domain = 16;
    optional string pod_dns_search_namespaces = 17;

    // Tracer options
    optional LightstepConfig lightstep = 30;
    optional ZipkinConfig zipkin = 31;

    // SDS settings
    optional SdsConfig sds = 40;

    // Passthrough to k8s resources.
    optional k8s.io.api.core.v1.Probe readiness_probe = 50;
    optional k8s.io.api.core.v1.ResourceRequirements resources = 51;

    // Additional arguments passed to Envoy.
    map<string, string> additional_args = 60;

    // Additional environment variables for the container.
    map<string, string> env = 70;

    // Kustomize style overrides for k8s resources in rendered manifests.
    repeated Object resource_override = 100;
}

message PolicyConfig {
}
message TelemetryConfig {
}
message SecurityConfig {
}
message ConfigManagementConfig {
}

message IngressGatewayConfig {
}
message EgressGatewayConfig {
}

// OperatorConfig defines a config used to install an external operator.
message OperatorConfig {
    // manifest_path is the URL for the operator install manifest.
    optional string manifest_path = 1;

    // namespace is the namespace the operator manifest and CR are installed into.
    optional string namespace = 2;

    // spec is the initial CR for the operator.
    optional Object spec = 3;
}

message IstioInstaller {
    optional InstallerSpec spec = 3;
    optional InstallerStatus status = 4;
}

message Object {
    optional k8s.io.apimachinery.pkg.apis.meta.v1.ObjectMeta metadata = 1;
    optional k8s.io.apimachinery.pkg.runtime.RawExtension data = 2;
}

// FIXME: this should be moved out
message SdsConfig {
    optional bool enabled = 1;
    optional string uds_path = 2;
    optional bool use_trustworthy_jwt = 3;
    optional bool use_normal_jwt = 4;
}
